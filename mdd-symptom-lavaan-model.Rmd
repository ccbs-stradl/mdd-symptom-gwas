---
title: CFA of MDD symptoms phenotypes
author: Mark Adams, Bradley Jermy, Jackson Thorp, Andrew Grotzinger, Michel Nivard 
output:
  github_document
---

Phenotype level CFA models of MDD symptoms. 

```{r lib}
library(dplyr)
library(lavaan)
```

# UKB CIDI

Load the phenotype file

```{r ukb_rds}
ukb_cidi <- readRDS("pheno/ukb_mhq_cidi_symptoms_screen_absent_present_contrasts.rds")
```

Rename symptoms to match the GenomicSEM analysis: UKB is one of the *Pop*ulation samples. 

```{r ukb_rename}

ab0pr1 <- function(symptom) case_when(symptom %in% c('Absent', 'Not present') ~ 0L,
						 			  symptom == 'Present' ~ 1L,
									  TRUE ~ NA_integer_)

ukb_symp <-
as_tibble(ukb_cidi) %>%
transmute(f.eid,
PopDep=ab0pr1(cidi_mood),
PopAnh=ab0pr1(cidi_anhed),
PopAppDec=ab0pr1(cidi_wloss),
PopAppInc=ab0pr1(cidi_wgain),
PopSleDec=ab0pr1(cidi_insomn),
PopSleInc=ab0pr1(cidi_hypersom),
PopFatig=ab0pr1(cidi_tired),
PopGuilt=ab0pr1(cidi_worth),
PopConc=ab0pr1(cidi_cnctr),
PopSui=ab0pr1(cidi_death)) %>%
filter_at(vars(starts_with('Pop')), any_vars(!is.na(.)))



```

# Models

## Common factor

```{r pop_common, cache=TRUE}

pop_commonfactor.model <- "
A1 =~ NA*PopDep + PopAnh + PopAppDec + PopAppInc + PopSleDec + PopSleInc + PopFatig + PopGuilt + PopConc + PopSui
A1 ~~ 1*A1
"

pop_commonfactor.fit <- cfa(model=pop_commonfactor.model, data=ukb_symp,  missing='ML')
							   
standardizedSolution(pop_commonfactor.fit)

```

Add negative residual correlations to directional symptoms

```{r pop_common_dir, cache=TRUE}

pop_commonfactor_dir.model <- "
A1 =~ NA*PopDep + PopAnh + PopAppDec + PopAppInc + PopSleDec + PopSleInc + PopFatig + PopGuilt + PopConc + PopSui
A1 ~~ 1*A1
PopAppDec ~~ PopAppInc
PopSleDec ~~ PopSleInc
"

pop_commonfactor_dir.fit <- cfa(model=pop_commonfactor_dir.model, data=ukb_symp,  missing='ML')
							   
standardizedSolution(pop_commonfactor_dir.fit)

```

## Two-factor models

### Psychological-Somatic (Elhai Model 2a)

```{r pop_psych_soma, cache=TRUE}

pop_psych_soma.model <- "
A1 =~ NA*PopDep + PopAnh + PopGuilt + PopConc + PopSui 
A2 =~ NA*PopAppDec + PopAppInc + PopSleDec + PopSleInc + PopFatig
A1 ~~ 1*A1
A2 ~~ 1*A2
PopAppDec ~~ PopAppInc
PopSleDec ~~ PopSleInc
"
pop_psych_soma.fit <- cfa(model=pop_psych_soma.model, data=ukb_symp, missing="ML")

standardizedSolution(pop_psych_soma.fit)

```

```{r pop_psych_soma_bif, cache=TRUE}

pop_psych_soma_bif.model <- "
A =~ NA*PopDep + PopAnh + PopAppDec + PopAppInc + PopSleDec + PopSleInc + PopFatig + PopGuilt + PopConc + PopSui
A1 =~ NA*PopDep + PopAnh + PopGuilt + PopConc + PopSui 
A2 =~ NA*PopAppDec + PopAppInc + PopSleDec + PopSleInc + PopFatig
A1 ~~ 1*A1
A2 ~~ 1*A2
A ~~ 0*A1 + 0*A2
A1 ~~ 0*A2
"
pop_psych_soma_bif.fit <- cfa(model=pop_psych_soma_bif.model, data=ukb_symp, missing="ML")

standardizedSolution(pop_psych_soma_bif.fit)

```


### Psychological-Neurovegetative (Elhai Model 2b)

```{r pop_psych_veg, cache=TRUE}

pop_psych_veg.model <- "
A1 =~ NA*PopDep + PopAnh + PopGuilt + PopSui
A2 =~ NA*PopAppDec + PopAppInc + PopSleDec + PopSleInc + PopFatig + PopConc
A1 ~~ 1*A1
A2 ~~ 1*A2
PopAppDec ~~ PopAppInc
PopSleDec ~~ PopSleInc
"
pop_psych_veg.fit <- cfa(model=pop_psych_veg.model, data=ukb_symp, missing="ML")

standardizedSolution(pop_psych_veg.fit)

```


```{r pop_psych_veg_bif, cache=TRUE}

pop_psych_veg_bif.model <- "
A1 =~ NA*PopDep + PopAnh + PopGuilt + PopSui
A2 =~ NA*PopAppDec + PopAppInc + PopSleDec + PopSleInc + PopFatig + PopConc
A  =~ NA*PopDep + PopAnh + PopGuilt + PopSui + PopAppDec + PopAppInc + PopSleDec + PopSleInc + PopFatig + PopConc
A1 ~~ 1*A1
A2 ~~ 1*A2
A  ~~ 1*A
A ~~ 0*A1
A ~~ 0*A2
A1 ~~ 0*A2
"

pop_psych_veg_bif.fit <- cfa(model=pop_psych_veg_bif.model, data=ukb_symp, missing="ML")

standardizedSolution(pop_psych_veg_bif.fit)

```


### Affective-Neurovegetative (Elhai Model 2c)

```{r pop_affect_veg, cache=TRUE}

pop_affect_veg.model <- "
A1 =~ NA*PopDep + PopGuilt + PopSui
A2 =~ NA*PopAnh + PopAppInc + PopAppDec + PopSleInc + PopSleDec + PopFatig + PopConc
A1 ~~ 1*A1
A2 ~~ 1*A2
PopAppDec ~~ PopAppInc
PopSleDec ~~ PopSleInc
"
pop_affect_veg.fit <- cfa(model=pop_affect_veg.model, data=ukb_symp, missing="ML")

standardizedSolution(pop_affect_veg.fit)

```


Bifactor model
```{r pop_affect_veg_bif, cache=TRUE}

pop_affect_veg_bif.model <- "
A1 =~ NA*PopDep + PopGuilt + PopSui
A2 =~ NA*PopAnh + PopAppInc + PopAppDec + PopSleInc + PopSleDec + PopFatig + PopConc
A =~ NA*PopDep + PopGuilt + PopSui + PopAnh + PopAppInc + PopAppDec + PopSleInc + PopSleDec + PopFatig + PopConc
A1 ~~ 1*A1
A2 ~~ 1*A2
A  ~~ 1*A
A ~~ 0*A1
A ~~ 0*A2
A1 ~~ 0*A2
"
pop_affect_veg_bif.fit <- cfa(model=pop_affect_veg_bif.model, data=ukb_symp, missing="ML")

standardizedSolution(pop_affect_veg_bif.fit)

```

## 3 factor models


```{r pop_cog_mood_neuroveg, cache=TRUE}

pop_cog_mood_neuroveg.model <- "
A1 =~ NA*PopGuilt + PopConc + PopSui
A2 =~ NA*PopDep + PopAnh + PopGuilt
A3 =~ NA*PopSleDec + PopSleInc + PopFatig + PopAppDec + PopAppInc
A1 ~~ 1*A1
A2 ~~ 1*A2
A3 ~~ 1*A3
PopSleDec ~~ PopSleInc
PopAppDec ~~ PopAppInc
"
pop_cog_mood_neuroveg.fit <- cfa(model=pop_cog_mood_neuroveg.model, data=ukb_symp, missing="ML")

standardizedSolution(pop_cog_mood_neuroveg.fit)

```


```{r pop_cog_mood_neuroveg_bif, cache=TRUE}

pop_cog_mood_neuroveg_bif.model <- "
A1 =~ NA*PopGuilt + PopConc + PopSui
A2 =~ NA*PopDep + PopAnh + PopGuilt
A3 =~ NA*PopSleDec + PopSleInc + PopFatig + PopAppDec + PopAppInc
A =~ NA*PopDep + PopGuilt + PopSui + PopAnh + PopAppInc + PopAppDec + PopSleInc + PopSleDec + PopFatig + PopConc
A1 ~~ 1*A1
A2 ~~ 1*A2
A3 ~~ 1*A3
A ~~ 0*A1 + 0*A2 + 0*A3
A1 ~~ 0*A2 + 0*A3
A2 ~~ 0*A3
"
pop_cog_mood_neuroveg_bif.fit <- cfa(model=pop_cog_mood_neuroveg_bif.model, data=ukb_symp, missing="ML")

standardizedSolution(pop_cog_mood_neuroveg_bif.fit)

```

# Model comparison

```{r model_comparison}

fits <- list(
pop_commonfactor.fit,
pop_commonfactor_dir.fit,

pop_psych_soma_bif.fit,
pop_psych_soma.fit,

pop_psych_veg_bif.fit,
pop_psych_veg.fit,

pop_affect_veg_bif.fit,
pop_affect_veg.fit,

pop_cog_mood_neuroveg.fit,
pop_cog_mood_neuroveg_bif.fit)

model_fits <- 
data.frame(Model=c('1a', '1b', '2a', '2a(ii)', '2b(i)', '2b(ii)', '2c(i)', '2c(ii)', '3', '3(ii)'),
   Name=c('Common',
		  'Common (direction)',
		  'Psych-Somatic',
		  'Psych-Somatic (BiF)',
		  'Psych-Neuroveg',
		  'Psych-Neuroveg (BiF)',
		  'Affect-Neuroveg',
		  'Affect-Neuroveg (BiF)',
		  'Cog-Mood-Neuroveg',
		  'Cog-Mood-Neuroveg (BiF)')) %>%
bind_cols(
bind_rows(lapply(fits, function(fit) fitMeasures(fit)[c('aic', 'bic', 'cfi', 'srmr')]))
)

model_fits %>%
mutate(dAIC=aic-min(aic)) %>%
select(-bic)

```

## Categorical models

Treat symptoms as ordered categorical variables

```{r ordered, cache=TRUE}

pop_commonfactor_ord.fit <- cfa(model=pop_commonfactor.model, data=ukb_symp, ordered=TRUE, missing='pairwise')

summary(pop_commonfactor_ord.fit, fit.measures=TRUE)

```
