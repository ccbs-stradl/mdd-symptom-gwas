---
title: GenomicSEM of MDD symptoms
author: Mark Adams, Bradley Jermy, Jackson Thorp, Andrew Grotzinger, Michel Nivard 
output:
  github_document
---


# Setup

## R packages

R version

```{r version}

R.version

```

Package installation

```{r packages, output='hide', warning=FALSE, message=FALSE, eval=FALSE}

required_packages <- c('devtools', 'readr', 'tidyr', 'dplyr', 'ggplot2', 'stringr', 'corrplot')
for(pack in required_packages) if(!require(pack, character.only=TRUE)) install.packages(pack)

if(!require(GenomicSEM)) remotes::install_github("MichelNivard/GenomicSEM")

```

GenomicSEM version

```{r requires, warning=FALSE, messages=FALSE}

require(readr)
require(tidyr)
require(stringr)
require(dplyr)
require(ggplot2)
require(corrplot)
require(GenomicSEM)

packageVersion("GenomicSEM")

```

# Symptom labels

MDD DSM symptoms are numbered 1-9:

```{r symptom_labels}

# plot labels

dsm_mdd_symptoms_labels <-
read_delim("
MDD1;Mood;Mood;Dep
MDD2;Interest;Interest;Anh
MDD3;Weight⇅;Weight⇆;App
MDD3a;Weight⇊;Weight⇇;AppDec
MDD3b;Weight⇈;Weight⇉;AppInc
MDD4;Sleep⇅;Sleep⇆;Sle
MDD4a;Sleep⇊;Sleep⇇;SleDec
MDD4b;Sleep⇈;Sleep⇉;SleInc
MDD5;Motor⇅;Motor⇆;Moto
MDD5a;Motor⇈;Motor⇉;MotoInc
MDD5b;Motor⇊;Motor⇇;MotoDec
MDD6;Fatigue;Fatigue;Fatig
MDD7;Guilt;Guilt;Guilt
MDD8;Concentrate;Concentrate;Conc
MDD9;Suicidality;Suicidality;Sui
", col_names=c('ref', 'h', 'v', 'abbv'), delim=';')

dsm_mdd_symptoms_reference <-
read_delim("
MDD1;Depressed mood most of the day, nearly every day
MDD2;Markedly diminished interest or pleasure in all, or almost all, activities most of the day, nearly every day
MDD3;Significant change in weight or appetite
MDD3a;Significant weight loss or decrease in appetite
MDD3b;Significant weight gain or increase in appetite
MDD4;Sleeping too much or not sleeping enough
MDD4a;Insomnia nearly every day
MDD4b;Hypersomnia nearly every day
MDD5;Changes in speed/amount of moving or speaking
MDD5a;Psychomotor agitation nearly every day
MDD5b;Psychomotor slowing nearly every day
MDD6;Fatigue or loss of energy nearly every day
MDD7;Feelings of worthlessness or excessive or inappropriate guilt
MDD8;Diminished ability to think or concentrate, or indecisiveness
MDD9;Recurrent thoughts of death or suicide or a suicide attempt or a specific plan for attempting suicide
", col_names=c('Reference', 'Description'), delim=';')

dsm_mdd_symptoms_reference %>%
left_join(dsm_mdd_symptoms_labels, by=c('Reference'='ref')) %>%
select(Reference, Abbreviation=abbv, Label=h, Description)

```

# GenomicSEM covariance structure

```{r covstruct}

covstruct_prefix <- 'agds_pgc.alspac_ukb.covstruct'
covstruct_r <- file.path('ldsc', paste(covstruct_prefix, 'deparse.R', sep='.'))
covstruct_rds <- file.path('ldsc', paste(covstruct_prefix, 'rds', sep='.'))

symptoms_covstruct <- dget(covstruct_r)

sumstats_prevs <- read_tsv(file.path('ldsc', paste(covstruct_prefix, 'prevs', 'txt', sep='.')))

```

Rename samples: AGDS/PGC is the **Clin**ical meta-analysis sample (`Clin`) and ALSPAC/UKB is the **Comm**unity meta-analysis sample (`Comm`); and rename symptoms numbers (`MDD1`, `MDD2`) to abbreviations (`Dep`, `Anh`). There are also extra measures of `MDD1` and `MDD2` from **UKB** Baseline data. 

```{r sem_labels}

cohorts_sample_symptoms <-
sumstats_prevs %>%
left_join(dsm_mdd_symptoms_labels, by=c('symptom'='ref')) %>%
select(cohorts, symptom, trait_name, abbv) %>%
mutate(Sample=case_when(cohorts %in% 'AGDS_PGC' ~ 'Clin',
                        cohorts %in% 'ALSPAC_UKB' ~ 'Comm',
                        cohorts %in% 'UKBt' ~ 'Ukb',
                        TRUE ~ NA_character_)) %>%
mutate(sample_symptom=paste0(Sample, abbv))

sample_symptoms <- cohorts_sample_symptoms$sample_symptom
names(sample_symptoms) <- cohorts_sample_symptoms$trait_name

# rename traits in covstruct
dimnames(symptoms_covstruct$S)[[2]] <-
as.vector(sample_symptoms[dimnames(symptoms_covstruct$S)[[2]]])

```

# Structural models

Symptoms with positive variances

```{r}

symptoms_S_var <- diag(symptoms_covstruct$S)
names(symptoms_S_var) <- dimnames(symptoms_covstruct$S)[[2]]

symptoms_S_var[which(symptoms_S_var > 0)]

```

## Common factor

Common factor across symptoms from both cohorts

```{r commonfactor, cache=TRUE}

commonfactor.model <- "
A1 =~ NA*ClinAppDec + ClinAppInc + ClinSleDec + ClinSleInc + ClinMotoInc + ClinMotoDec + ClinSui + CommDep + CommAnh + CommAppDec + CommAppInc + CommSleDec + CommSleInc + CommFatig + CommGuilt + CommConc + CommSui + UkbDep + UkbAnh

A1 ~~ 1*A1
"

commonfactor.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=commonfactor.model)

commonfactor.fit$modelfit
commonfactor.fit$results[c(1,2,3,6,7)]

```

## Correlation among directional symptoms

```{r commonfactor_app, cache=TRUE}

commonfactor_app.model <- "
A1 =~ NA*ClinAppDec + ClinAppInc + ClinSleDec + ClinSleInc + ClinMotoInc + ClinMotoDec + ClinSui + CommDep + CommAnh + CommAppDec + CommAppInc + CommSleDec + CommSleInc + CommFatig + CommGuilt + CommConc + CommSui + UkbDep + UkbAnh
App =~ NA*ClinAppDec + ClinAppInc + CommAppDec + CommAppInc

A1 ~~ 1*A1
App ~~ 1*App
A1 ~~ 0*App
"

commonfactor_app.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=commonfactor_app.model)

commonfactor_app.fit$modelfit
commonfactor_app.fit$results[c(1,2,3,6,7,9)]

```

```{r commonfactor_sle, cache=TRUE}

commonfactor_sle.model <- "
A1 =~ NA*ClinAppDec + ClinAppInc + ClinSleDec + ClinSleInc + ClinMotoInc + ClinMotoDec + ClinSui + CommDep + CommAnh + CommAppDec + CommAppInc + CommSleDec + CommSleInc + CommFatig + CommGuilt + CommConc + CommSui + UkbDep + UkbAnh
Sle =~ NA*ClinSleDec + ClinSleInc + CommSleDec + CommSleInc

A1 ~~ 1*A1
Sle ~~ 1*Sle
A1 ~~ 0*Sle

c4a > 0
CommSleDec ~~ c4a*CommSleDec
"

commonfactor_sle.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=commonfactor_sle.model)

commonfactor_sle.fit$modelfit
commonfactor_sle.fit$results[c(1,2,3,6,7,9)]

```

## Ascertainment-specific factors

```{r clin_pop, cache=TRUE}

clin_comm.model <- "
A2 =~ NA*ClinAppDec + ClinAppInc + ClinSleDec + ClinSleInc + ClinMotoInc + ClinMotoDec + ClinSui
A3 =~ NA*CommDep + CommAnh + CommAppDec + CommAppInc + CommSleDec + CommSleInc + CommFatig + CommGuilt + CommConc + CommSui + UkbDep + UkbAnh

A2 ~~ 1*A2
A3 ~~ 1*A3
"

clin_comm.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=clin_comm.model)

clin_comm.fit$modelfit
clin_comm.fit$results[c(1,2,3,6,7,9)]

```

Community gating symptom factors (Depression and Anhedonia)

```{r card, cache=TRUE}

gate.model <- "
A1 =~ NA*ClinAppDec + ClinAppInc + ClinSleDec + ClinSleInc + ClinMotoInc + ClinMotoDec + ClinSui + CommDep + CommAnh + CommAppDec + CommAppInc + CommSleDec + CommSleInc + CommFatig + CommGuilt + CommConc + CommSui + UkbDep + UkbAnh
Gate =~ NA*CommDep + CommAnh + UkbDep + UkbAnh

A1 ~~ 1*A1
Gate ~~ 1*Gate
A1 ~~ 0*Gate
"

gate.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=gate.model)

gate.fit$modelfit
gate.fit$results[c(1,2,3,6,7)]

```

## Baseline gating and directional symptoms factors

```{r base, cache=TRUE}

base.model <- "
A1 =~ NA*ClinAppDec + ClinAppInc + ClinSleDec + ClinSleInc + ClinMotoInc + ClinMotoDec + ClinSui + CommDep + CommAnh + CommAppDec + CommAppInc + CommSleDec + CommSleInc + CommFatig + CommGuilt + CommConc + CommSui + UkbDep + UkbAnh

Gate =~ NA*CommDep + CommAnh + UkbDep + UkbAnh
App =~ NA*ClinAppDec + ClinAppInc + CommAppDec + CommAppInc
Sle =~ NA*ClinSleDec + ClinSleInc + CommSleDec + CommSleInc

A1 ~~ 1*A1
Gate ~~ 1*Gate
App ~~ 1*App
Sle ~~ 1*Sle
A1 ~~ 0*Gate + 0*App + 0*Sle
Gate ~~ 0*App + 0*Sle
App ~~ 0*Sle

c4a > 0
CommSleDec ~~ c4a*CommSleDec
u1 > 0
UkbDep ~~ u1*UkbDep
"

base.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=base.model)

base.fit$modelfit
base.fit$results[c(1,2,3,6,7)]

```


## Two-factor models

[Elhai Psychiat Res 2012](https://www.sciencedirect.com/science/article/pii/S0165178112002685) compared 3 two-factor models

### Psychological-Somatic (Elhai Model 2a)

[Krause Rehab Psychol 2008](https://psycnet.apa.org/record/2008-17022-011), [Krause Arch Psys Med Rehab 2010](https://www.sciencedirect.com/science/article/pii/S0003999310002443):

> the 2-factor solution with 3 somatic items (sleep disturbance, poor energy, appetite change) was a better solution than either a unidimensional model or 2-factor model that included psychomotor slowing as a fourth somatic item

```{r psych_soma, cache=TRUE}

psych_soma.model <- "
A1 =~ NA*ClinMotoInc + ClinMotoDec + ClinSui + CommDep + CommAnh + CommGuilt + CommConc + CommSui + UkbDep + UkbAnh
A2 =~ NA*ClinAppDec + ClinAppInc + ClinSleDec + ClinSleInc + CommAppDec + CommAppInc + CommSleDec + CommSleInc + CommFatig

Gate =~ NA*CommDep + CommAnh + UkbDep + UkbAnh
App =~ NA*ClinAppDec + ClinAppInc + CommAppDec + CommAppInc
Sle =~ NA*ClinSleDec + ClinSleInc + CommSleDec + CommSleInc

A1 ~~ 1*A1
A2 ~~ 1*A2
Gate ~~ 1*Gate
App ~~ 1*App
Sle ~~ 1*Sle
A1 ~~ 0*Gate + 0*App + 0*Sle
A2 ~~ 0*Gate + 0*App + 0*Sle
Gate ~~ 0*App + 0*Sle
App ~~ 0*Sle
"

psych_soma.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=psych_soma.model)

psych_soma.fit$modelfit
psych_soma.fit$results[c(1,2,3,6,7)]

```


### Psychological-Neurovegetative (Elhai Model 2b)

```{r psych_veg, cache=TRUE}

pop_psych_veg.model <- "
A1 =~ NA*PopDep + PopAnh + PopGuilt + PopSui
A2 =~ NA*PopAppDec + PopAppInc + PopSleDec + PopSleInc + PopFatig + PopConc
A1 ~~ 1*A1
A2 ~~ 1*A2
PopDep ~~ PopAnh
"
pop_psych_veg.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=pop_psych_veg.model)

pop_psych_veg.fit$modelfit
pop_psych_veg.fit$results[c(1,2,3,6,7)]

```


### Affective-Neurovegetative (Elhai Model 2c)

```{r pop_affect_veg, cache=TRUE}

pop_affect_veg.model <- "
A1 =~ NA*PopDep + PopGuilt + PopSui
A2 =~ NA*PopAnh + PopAppInc + PopAppDec + PopSleInc + PopSleDec + PopFatig + PopConc
A1 ~~ 1*A1
A2 ~~ 1*A2
PopDep ~~ PopAnh
"
pop_affect_veg.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=pop_affect_veg.model)

pop_affect_veg.fit$modelfit
pop_affect_veg.fit$results[c(1,2,3,6,7)]

```


Bifactor model
```{r pop_affect_veg_bif, cache=TRUE}

pop_affect_veg_bif.model <- "
A1 =~ NA*PopDep + PopGuilt + PopSui
A2 =~ NA*PopAnh + PopAppInc + PopAppDec + PopSleInc + PopSleDec + PopFatig + PopConc
A =~ NA*PopDep + PopGuilt + PopSui + PopAnh + PopAppInc + PopAppDec + PopSleInc + PopSleDec + PopFatig + PopConc
A1 ~~ 1*A1
A2 ~~ 1*A2
A  ~~ 1*A
A ~~ 0*A1
A ~~ 0*A2
A1 ~~ 0*A2
PopDep ~~ PopAnh
"
pop_affect_veg_bif.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=pop_affect_veg_bif.model)

```


```{r pop_affect_veg_bif_constr, cache=TRUE}

pop_affect_veg_bif_constr.model <- "
a2 < 1
A1 =~ NA*PopDep + PopGuilt + PopSui
A2 =~ NA*PopAnh + PopAppInc + PopAppDec + PopSleInc + PopSleDec + PopFatig + PopConc
A =~ NA*PopDep + PopGuilt + PopSui + a2*PopAnh + PopAppInc + PopAppDec + PopSleInc + PopSleDec + PopFatig + PopConc
A1 ~~ 1*A1
A2 ~~ 1*A2
A  ~~ 1*A
A ~~ 0*A1
A ~~ 0*A2
A1 ~~ 0*A2
PopDep ~~ PopAnh
c4a > 0.001
PopSleDec ~~ c4a*PopSleDec
c4b > 0.001
PopSleInc ~~ c4b*PopSleInc
"
pop_affect_veg_bif_constr.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=pop_affect_veg_bif_constr.model, fix_resid=FALSE)

pop_affect_veg_bif_constr.fit$modelfit
pop_affect_veg_bif_constr.fit$results[c(1,2,3,6,7)]

```

## Three factor models

### Cognitive-Mood-Neuroveg (Kendler Neale) model

```{r pop_cog_mood_neuroveg, cache=TRUE}

pop_cog_mood_neuroveg.model <- "
A1 =~ NA*PopGuilt + PopConc + PopSui
A2 =~ NA*PopDep + PopAnh + PopGuilt
A3 =~ NA*PopSleDec + PopSleInc + PopFatig + PopAppDec + PopAppInc
A1 ~~ 1*A1
A2 ~~ 1*A2
A3 ~~ 1*A3
"
pop_cog_mood_neuroveg.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=pop_cog_mood_neuroveg.model)

```

Add constraints to prevent variances from being negative and correlations from going out of bounds.
```{r pop_cog_mood_neuroveg_constr, cache=TRUE}

pop_cog_mood_neuroveg_constr.model <- "
A1 =~ NA*PopGuilt + PopConc + PopSui
A2 =~ NA*PopDep + PopAnh + PopGuilt
A3 =~ NA*PopSleDec + PopSleInc + PopFatig + PopAppDec + PopAppInc
A1 ~~ 1*A1
A2 ~~ 1*A2
A3 ~~ 1*A3
c2 > 0.001
PopAnh ~~ c2*PopAnh
a13 < 0.99
A1 ~~ a13*A3
"
pop_cog_mood_neuroveg_constr.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=pop_cog_mood_neuroveg_constr.model, fix_resid=FALSE)

pop_cog_mood_neuroveg_constr.fit$modelfit
pop_cog_mood_neuroveg_constr.fit$results[c(1, 2, 3, 6, 7)]

```

### Model comparisons

```{r pop_model_list}

pop_model_list=
list("1a"=list(name="Common", model=pop_commonfactor.fit),
     "1b"=list(name="Common (gating)", model=pop_commonfactor_gating.fit),
     "1c"=list(name="Common (App)", model=pop_commonfactor_app.fit),
     "1d"=list(name="Common (Sle)", model=pop_commonfactor_sle.fit),
     "1er"=list(name="Common (App,Sle)", model=pop_commonfactor_app_sle.fit),
     "2a(i)"=list(name="Psych-Somatic", model=pop_psych_soma_constr.fit),
     "2a(ii)"=list(name="Psych-Somatic (BiF)", model=pop_psych_soma_bif.fit),
     "2b(i)"=list(name="Psych-Neuroveg", model=pop_psych_veg.fit),
     "2b(ii)"=list(name="Psych-Neuroveg (BiF)", model=pop_psych_veg_bif.fit),
     "2c(i)"=list(name="Affect-Neuroveg", model=pop_affect_veg.fit),
     "2c(ii)"=list(name="Affect-Neuroveg (BiF)", model=pop_affect_veg_bif_constr.fit),
     "3"=list(name="Cog-Mood-Neuroveg", model=pop_cog_mood_neuroveg_constr.fit)
     )

pop_model_fits <- 
data.frame(Model=names(pop_model_list),
           Name=sapply(pop_model_list, function(m) m$name)) %>%
bind_cols(
bind_rows(
lapply(pop_model_list, function(m) m$model$modelfit)
))
rownames(pop_model_fits) <- NULL

knitr::kable(
pop_model_fits %>%
mutate(dAIC=AIC-min(AIC)) %>%
mutate_if(is.numeric, ~signif(., 3))
)


```
       
# Clinical and population factors

```{r clin_pop_affect_veg, cache=TRUE}

clin_pop_affect_veg.model <- "
ClinSOMA =~ NA*ClinAppInc + ClinSleDec + ClinSleInc + ClinMotoInc
ClinAPPDEC =~ ClinAppDec
ClinSUI =~ ClinSui
PopAFFECT =~ NA*PopDep + PopGuilt + PopSui
PopNEUROVEG =~ NA*PopAnh + PopAppInc + PopAppDec + PopSleInc + PopSleDec + PopFatig + PopConc
ClinSOMA ~~ 1*ClinSOMA
PopAFFECT ~~ 1*PopAFFECT
PopNEUROVEG ~~ 1*PopNEUROVEG
PopDep ~~ PopAnh
ClinAppDec ~~ ClinAppInc
ClinAppDec ~~ 0*ClinAppDec
ClinSui ~~ 0*ClinSui
"

clin_pop_affect_veg.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=clin_pop_affect_veg.model)

clin_pop_affect_veg.fit$modelfit
clin_pop_affect_veg.fit$results[c(1,2,3,6,7,9)]

```

# Exploratory factor analysis

Get the genetic covariance matrix for symptoms with a positive heritability

```{r mdd_symptoms_cov}

symptoms_cov <- symptoms_covstruct$S
k <- nrow(symptoms_cov)
symptoms_se <- matrix(0, k, k)
symptoms_se[lower.tri(symptoms_se, diag=TRUE)] <- sqrt(diag(symptoms_covstruct$V))

symptoms_se[upper.tri(symptoms_se)] <- t(symptoms_se)[upper.tri(symptoms_se)]

symptoms_cov_keep <- which(diag(symptoms_cov > 0))

symptoms_cov_pos <- symptoms_cov[symptoms_cov_keep,symptoms_cov_keep]

```

Smooth the genetic covariance matrix so that it is positive definite
```{r mdd_symptom_gsem_efa_pd}

# smooth the covariance matrix
symptoms_cov_pd <- as.matrix(Matrix::nearPD(symptoms_cov_pos, corr=FALSE)$mat)

corrplot(cov2cor(symptoms_cov_pd))

```

## PGC/AGDS


Check eigen values of the correlation matrix
```{r mdd_symptom_gsem_clin_efa_eigen}

symptoms_clin_idx <- which(str_detect(dimnames(symptoms_cov_pd)[[1]], 'Clin'))

symptoms_clin_eigen <- eigen(cov2cor(symptoms_cov_pd[symptoms_clin_idx,symptoms_clin_idx])) 

plot(symptoms_clin_eigen$values, ylab='Eigenvalue')
lines(symptoms_clin_eigen$values)
abline(1, 0, col='red')

symptoms_clin_efa <- factanal(covmat=symptoms_cov_pd[symptoms_clin_idx,symptoms_clin_idx], factors=3, rotation='varimax')
symptoms_clin_efa

```

## ALSPAC/UKB

Check eigen values of the correlation matrix
```{r mdd_symptom_gsem_pop_efa_eigen}

symptoms_pop_idx <- which(str_detect(dimnames(symptoms_cov_pd)[[1]], 'Pop'))

symptoms_pop_eigen <- eigen(cov2cor(symptoms_cov_pd[symptoms_pop_idx,symptoms_pop_idx])) 

plot(symptoms_pop_eigen$values, ylab='Eigenvalue')
lines(symptoms_pop_eigen$values)
abline(1, 0, col='red')

symptoms_pop_efa <- factanal(covmat=symptoms_cov_pd[symptoms_pop_idx,symptoms_pop_idx], factors=3, rotation='varimax')
symptoms_pop_efa

```


# All symptoms


```{r all_covstruct}

all_covstruct_prefix <- 'all.covstruct'
all_covstruct_r <- file.path('ldsc', paste(all_covstruct_prefix, 'deparse.R', sep='.'))
all_covstruct_rds <- file.path('ldsc', paste(all_covstruct_prefix, 'rds', sep='.'))

all_symptoms_covstruct <- dget(all_covstruct_r)

all_sumstats_prevs <- read_tsv(file.path('ldsc', paste(all_covstruct_prefix, 'prevs', 'txt', sep='.')))

```

```{r all_sem_labels}

all_cohorts_sample_symptoms <-
all_sumstats_prevs %>%
left_join(dsm_mdd_symptoms_labels, by=c('symptom'='ref')) %>%
select(symptom, trait_name, abbv)

all_sample_symptoms <- all_cohorts_sample_symptoms$abbv
all_sample_symptoms
names(all_sample_symptoms) <- all_cohorts_sample_symptoms$trait_name
all_sample_symptoms[c('UKBt.MDD1', 'UKBt.MDD2')] <- c('Dep1', 'Anh1')

# rename traits in covstruct
dimnames(all_symptoms_covstruct$S)[[2]] <-
as.vector(all_sample_symptoms[dimnames(all_symptoms_covstruct$S)[[2]]])

# positive variances
dimnames(all_symptoms_covstruct$S)[[2]][which(diag(all_symptoms_covstruct$S) > 0)]

```

## Common factor


```{r all_commonfactor, cache=TRUE}

all_commonfactor.model <- "
A1 =~ NA*Dep + Anh + AppDec + AppInc + SleDec + SleInc + MotoInc + Fatig + Guilt + Conc + Sui + Dep1 + Anh1
A1 ~~ 1*A1
"
all_commonfactor.fit <- usermodel(all_symptoms_covstruct, estimation='DWLS', model=all_commonfactor.model)

all_commonfactor.fit$modelfit
all_commonfactor.fit$results[c(1, 2, 3, 6, 7)]

```

```{r all_commonfactor, cache=TRUE}

all_commonfactor.model <- "
A1 =~ NA*Dep + Anh + AppDec + AppInc + SleDec + SleInc + MotoInc + Fatig + Guilt + Conc + Dep1 + Anh1
A1 ~~ 1*A1
AppDec ~~ AppInc
SleDec ~~ SleInc
"
all_commonfactor.fit <- usermodel(all_symptoms_covstruct, estimation='DWLS', model=all_commonfactor.model)

all_commonfactor.fit$modelfit
all_commonfactor.fit$results[c(1, 2, 3, 6, 7)]

```

Gateinal symptom factor among meta-analysed and community-only symptoms

```{r all_commonfactor_cardinal, cache=TRUE}

all_commonfactor_cardinal.model <- "
C1 =~ NA*Dep + Anh + Dep1 + Anh1
C1 ~~ 1*C1
"

all_commonfactor_cardinal.fit <- usermodel(all_symptoms_covstruct, estimation='DWLS', model=all_commonfactor_cardinal.model)

all_commonfactor_cardinal.fit$modelfit
all_commonfactor_cardinal.fit$results[c(1, 2, 3, 6, 7)]

```

```{r all_commonfactor_cardinal, cache=TRUE}

all_commonfactor_cardinal.model <- "
A1 =~ NA*Dep + Anh + AppDec + AppInc + SleDec + SleInc + MotoInc + Fatig + Guilt + Conc + Dep1 + Anh1
C1 =~ c*Dep + c*Anh + c*Dep1 + c*Anh1
A1 ~~ 1*A1
A1 ~~ 0*C1
"
all_commonfactor_cardinal.fit <- usermodel(all_symptoms_covstruct, estimation='DWLS', model=all_commonfactor_cardinal.model)

all_commonfactor_cardinal.fit$modelfit
all_commonfactor_cardinal.fit$results[c(1, 2, 3, 6, 7)]

```

```{r all_commonfactor_cardinal, cache=TRUE}

all_commonfactor_cardinal.model <- "
A1 =~ NA*Dep + Anh + AppDec + AppInc + SleDec + SleInc + MotoInc + Fatig + Guilt + Conc
C1 =~ NA*Dep + Anh + Dep1 + Anh1
A1 ~~ 1*A1
C1 ~~ 1*C1
"
all_commonfactor_cardinal.fit <- usermodel(all_symptoms_covstruct, estimation='DWLS', model=all_commonfactor_cardinal.model)

all_commonfactor_cardinal.fit$modelfit
all_commonfactor_cardinal.fit$results[c(1, 2, 3, 6, 7)]

```

Appetite symptom correlation

```{r all_commonfactor_app, cache=TRUE}

all_commonfactor_app.model <- "
A1 =~ NA*Dep + Anh + AppDec + AppInc + SleDec + SleInc + MotoInc + Fatig + Guilt + Conc + Sui
A1 ~~ 1*A1
Dep ~~ Anh
AppDec ~~ AppInc
"
all_commonfactor_app.fit <- usermodel(all_symptoms_covstruct, estimation='DWLS', model=all_commonfactor_app.model)

all_commonfactor_app.fit$modelfit
all_commonfactor_app.fit$results[c(1, 2, 3, 6, 7)]

```


Sleep symptom correlation

```{r all_commonfactor_sle, cache=TRUE}

all_commonfactor_sle.model <- "
A1 =~ NA*Dep + Anh + AppDec + AppInc + SleDec + SleInc + MotoInc + Fatig + Guilt + Conc + Sui
A1 ~~ 1*A1
Dep ~~ Anh
SleDec ~~ SleInc
"
all_commonfactor_sle.fit <- usermodel(all_symptoms_covstruct, estimation='DWLS', model=all_commonfactor_sle.model)

all_commonfactor_sle.fit$modelfit
all_commonfactor_sle.fit$results[c(1, 2, 3, 6, 7)]

```


```{r all_commonfactor_app_sle, cache=TRUE}

all_commonfactor_app_sle.model <- "
A1 =~ NA*Dep + Anh + AppDec + AppInc + SleDec + SleInc + MotoInc + Fatig + Guilt + Conc + Sui
A1 ~~ 1*A1
Dep ~~ Anh
AppDec ~~ AppInc
SleDec ~~ SleInc
"
all_commonfactor_app_sle.fit <- usermodel(all_symptoms_covstruct, estimation='DWLS', model=all_commonfactor_app_sle.model)

all_commonfactor_app_sle.fit$modelfit
all_commonfactor_app_sle.fit$results[c(1, 2, 3, 6, 7)]

```

## Two-factor models

```{r all_psych_soma, cache=TRUE}

all_psych_soma.model <- "
A1 =~ NA*Dep + Anh + Guilt + Conc + Sui 
A2 =~ NA*AppDec + AppInc + SleDec + SleInc + MotoInc + Fatig
A1 ~~ 1*A1
A2 ~~ 1*A2
Dep ~~ Anh
AppDec ~~ AppInc
"
all_psych_soma.fit <- usermodel(all_symptoms_covstruct, estimation='DWLS', model=all_psych_soma.model)

all_psych_soma.fit$modelfit
all_psych_soma.fit$results[c(1, 2, 3, 6, 7)]

```


```{r all_psych_veg, cache=TRUE}

all_psych_veg.model <- "
A1 =~ NA*Dep + Anh + Guilt + Sui 
A2 =~ NA*AppDec + AppInc + SleDec + SleInc + MotoInc + Fatig + Conc
A1 ~~ 1*A1
A2 ~~ 1*A2
Dep ~~ Anh
AppDec ~~ AppInc
"
all_psych_veg.fit <- usermodel(all_symptoms_covstruct, estimation='DWLS', model=all_psych_veg.model)

all_psych_veg.fit$modelfit
all_psych_veg.fit$results[c(1, 2, 3, 6, 7)]

```

```{r all_affect_veg, cache=TRUE}

all_affect_veg.model <- "
A1 =~ NA*Dep + Guilt + Sui 
A2 =~ NA*Anh + AppDec + AppInc + SleDec + SleInc + MotoInc + Fatig + Conc
A1 ~~ 1*A1
A2 ~~ 1*A2
Dep ~~ Anh
AppDec ~~ AppInc
"
all_affect_veg.fit <- usermodel(all_symptoms_covstruct, estimation='DWLS', model=all_affect_veg.model)

all_affect_veg.fit$modelfit
all_affect_veg.fit$results[c(1, 2, 3, 6, 7)]

```

### Three factor model

```{r all_cog_mood_neuroveg, cache=TRUE}

all_cog_mood_neuroveg.model <- "
A1 =~ NA*Guilt + Conc + Sui 
A2 =~ NA*Dep + Anh + Guilt
A3 =~ NA*AppDec + AppInc + SleDec + SleInc + MotoInc + Fatig
A1 ~~ 1*A1
A2 ~~ 1*A2
A3 ~~ 1*A3
AppDec ~~ AppInc
c2 > 0.001
Anh ~~ c2*Anh
a12 < 0.99
A1 ~~ a12*A2
"
all_cog_mood_neuroveg.fit <- usermodel(all_symptoms_covstruct, estimation='DWLS', model=all_cog_mood_neuroveg.model)

all_cog_mood_neuroveg.fit$modelfit
all_cog_mood_neuroveg.fit$results[c(1, 2, 3, 6, 7)]

```


### Model comparisons

```{r all_model_list}

all_model_list=
list("1a"=list(name="Common", model=all_commonfactor.fit),
     "1b"=list(name="Common (cardinal)", model=all_commonfactor_cardinal.fit),
     "1c"=list(name="Common (App)", model=all_commonfactor_app.fit),
     "1d"=list(name="Common (Sle)", model=all_commonfactor_sle.fit),
     "1er"=list(name="Common (App,Sle)", model=all_commonfactor_app_sle.fit),
     "2a(i)"=list(name="Psych-Somatic", model=all_psych_soma.fit),
     "2b(i)"=list(name="Psych-Neuroveg", model=all_psych_veg.fit),
     "2c(i)"=list(name="Affect-Neuroveg", model=all_affect_veg.fit),
     "3"=list(name="Cog-Mood-Neuroveg", model=all_cog_mood_neuroveg.fit)
     )

all_model_fits <- 
data.frame(Model=names(all_model_list),
           Name=sapply(all_model_list, function(m) m$name)) %>%
bind_cols(
bind_rows(
lapply(all_model_list, function(m) m$model$modelfit)
))
rownames(all_model_fits) <- NULL

knitr::kable(
all_model_fits %>%
mutate(dAIC=AIC-min(AIC)) %>%
mutate_if(is.numeric, ~signif(., 3))
)
```