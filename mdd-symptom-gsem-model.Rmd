---
title: GenomicSEM of MDD symptoms
author: Mark Adams, Bradley Jermy, Jackson Thorp, Andrew Grotzinger, Michel Nivard 
output:
  github_document
---


# Setup

## R packages

R version

```{r version}

R.version

```

Package installation

```{r packages, output='hide', warning=FALSE, message=FALSE, eval=FALSE}

required_packages <- c('devtools', 'readr', 'tidyr', 'dplyr', 'ggplot2', 'stringr', 'corrplot')
for(pack in required_packages) if(!require(pack, character.only=TRUE)) install.packages(pack)

if(!require(GenomicSEM)) remotes::install_github("MichelNivard/GenomicSEM")

```

GenomicSEM version

```{r requires, warning=FALSE, messages=FALSE}

require(readr)
require(tidyr)
require(stringr)
require(dplyr)
require(ggplot2)
require(corrplot)
require(GenomicSEM)

packageVersion("GenomicSEM")

```

# Symptom labels

MDD DSM symptoms are numbered 1-9:

```{r symptom_labels}

# plot labels

dsm_mdd_symptoms_labels <-
read_delim("
MDD1;Mood;Mood;Dep
MDD2;Interest;Interest;Anh
MDD3;Weight⇅;Weight⇆;App
MDD3a;Weight⇊;Weight⇇;AppDec
MDD3b;Weight⇈;Weight⇉;AppInc
MDD4;Sleep⇅;Sleep⇆;Sle
MDD4a;Sleep⇊;Sleep⇇;SleDec
MDD4b;Sleep⇈;Sleep⇉;SleInc
MDD5;Motor⇅;Motor⇆;Moto
MDD5a;Motor⇈;Motor⇉;MotoInc
MDD5b;Motor⇊;Motor⇇;MotoDec
MDD6;Fatigue;Fatigue;Fatig
MDD7;Guilt;Guilt;Guilt
MDD8;Concentrate;Concentrate;Conc
MDD9;Suicidality;Suicidality;Sui
", col_names=c('ref', 'h', 'v', 'abbv'), delim=';')

dsm_mdd_symptoms_reference <-
read_delim("
MDD1;Depressed mood most of the day, nearly every day
MDD2;Markedly diminished interest or pleasure in all, or almost all, activities most of the day, nearly every day
MDD3;Significant change in weight or appetite
MDD3a;Significant weight loss or decrease in appetite
MDD3b;Significant weight gain or increase in appetite
MDD4;Sleeping too much or not sleeping enough
MDD4a;Insomnia nearly every day
MDD4b;Hypersomnia nearly every day
MDD5;Changes in speed/amount of moving or speaking
MDD5a;Psychomotor agitation nearly every day
MDD5b;Psychomotor slowing nearly every day
MDD6;Fatigue or loss of energy nearly every day
MDD7;Feelings of worthlessness or excessive or inappropriate guilt
MDD8;Diminished ability to think or concentrate, or indecisiveness
MDD9;Recurrent thoughts of death or suicide or a suicide attempt or a specific plan for attempting suicide
", col_names=c('Reference', 'Description'), delim=';')

dsm_mdd_symptoms_reference %>%
left_join(dsm_mdd_symptoms_labels, by=c('Reference'='ref')) %>%
select(Reference, Abbreviation=abbv, Label=h, Description)

```

# GenomicSEM covariance structure

```{r covstruct}

covstruct_prefix <- 'agds_pgc.alspac_ukb.covstruct'
covstruct_r <- file.path('ldsc', paste(covstruct_prefix, 'deparse.R', sep='.'))
covstruct_rds <- file.path('ldsc', paste(covstruct_prefix, 'rds', sep='.'))

symptoms_covstruct <- dget(covstruct_r)

sumstats_prevs <- read_tsv(file.path('ldsc', paste(covstruct_prefix, 'prevs', 'txt', sep='.')))

```

Rename samples: AGDS/PGC is the **Clin**ical meta-analysis sample (`Clin`) and ALSPAC/UKB is the **Comm**unity meta-analysis sample (`Comm`); and rename symptoms numbers (`MDD1`, `MDD2`) to abbreviations (`Dep`, `Anh`). There are also extra measures of `MDD1` and `MDD2` from **UKB** Baseline data. 

```{r sem_labels}

cohorts_sample_symptoms <-
sumstats_prevs %>%
left_join(dsm_mdd_symptoms_labels, by=c('symptom'='ref')) %>%
select(cohorts, symptom, trait_name, abbv) %>%
mutate(Sample=case_when(cohorts %in% 'AGDS_PGC' ~ 'Clin',
                        cohorts %in% 'ALSPAC_UKB' ~ 'Comm',
                        cohorts %in% 'UKBt' ~ 'Ukb',
                        TRUE ~ NA_character_)) %>%
mutate(sample_symptom=paste0(Sample, abbv))

sample_symptoms <- cohorts_sample_symptoms$sample_symptom
names(sample_symptoms) <- cohorts_sample_symptoms$trait_name

# rename traits in covstruct
dimnames(symptoms_covstruct$S)[[2]] <-
as.vector(sample_symptoms[dimnames(symptoms_covstruct$S)[[2]]])

```

# Structural models

Symptoms with positive variances

```{r}

symptoms_S_var <- diag(symptoms_covstruct$S)
names(symptoms_S_var) <- dimnames(symptoms_covstruct$S)[[2]]

symptoms_S_var[which(symptoms_S_var > 0)]

```

## Common factor

Common factor across symptoms from both cohorts

```{r commonfactor, cache=TRUE}

commonfactor.model <- "
MDD =~ NA*ClinAppDec + ClinAppInc + ClinSleDec + ClinSleInc + ClinMotoInc + ClinMotoDec + ClinSui + CommDep + CommAnh + CommAppDec + CommAppInc + CommSleDec + CommSleInc + CommFatig + CommGuilt + CommConc + CommSui + UkbDep + UkbAnh

MDD ~~ 1*MDD
"

commonfactor.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=commonfactor.model)

commonfactor.fit$modelfit
commonfactor.fit$results[c(1,2,3,6,7)]

```

## Correlation among directional symptoms

```{r commonfactor_app, cache=TRUE}

commonfactor_app.model <- "
MDD =~ NA*ClinAppDec + ClinAppInc + ClinSleDec + ClinSleInc + ClinMotoInc + ClinMotoDec + ClinSui + CommDep + CommAnh + CommAppDec + CommAppInc + CommSleDec + CommSleInc + CommFatig + CommGuilt + CommConc + CommSui + UkbDep + UkbAnh
APP =~ NA*ClinAppDec + ClinAppInc + CommAppDec + CommAppInc

MDD ~~ 1*MDD
APP ~~ 1*APP
MDD ~~ 0*APP
"

commonfactor_app.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=commonfactor_app.model)

commonfactor_app.fit$modelfit
commonfactor_app.fit$results[c(1,2,3,6,7,9)]

```

```{r commonfactor_sle, cache=TRUE}

commonfactor_sle.model <- "
MDD =~ NA*ClinAppDec + ClinAppInc + ClinSleDec + ClinSleInc + ClinMotoInc + ClinMotoDec + ClinSui + CommDep + CommAnh + CommAppDec + CommAppInc + CommSleDec + CommSleInc + CommFatig + CommGuilt + CommConc + CommSui + UkbDep + UkbAnh
SLE =~ NA*ClinSleDec + ClinSleInc + CommSleDec + CommSleInc

MDD ~~ 1*MDD
SLE ~~ 1*SLE
MDD ~~ 0*SLE

c4a > 0
CommSleDec ~~ c4a*CommSleDec
"

commonfactor_sle.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=commonfactor_sle.model)

commonfactor_sle.fit$modelfit
commonfactor_sle.fit$results[c(1,2,3,6,7,9)]

```

## Ascertainment-specific factors

```{r clin_pop, cache=TRUE}

clin_comm.model <- "
CLIN =~ NA*ClinAppDec + ClinAppInc + ClinSleDec + ClinSleInc + ClinMotoInc + ClinMotoDec + ClinSui
COMM =~ NA*CommDep + CommAnh + CommAppDec + CommAppInc + CommSleDec + CommSleInc + CommFatig + CommGuilt + CommConc + CommSui + UkbDep + UkbAnh

CLIN ~~ 1*CLIN
COMM ~~ 1*COMM
"

clin_comm.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=clin_comm.model)

clin_comm.fit$modelfit
clin_comm.fit$results[c(1,2,3,6,7,9)]

```

Community gating symptom factors (Depression and Anhedonia)

```{r gate, cache=TRUE}

gate.model <- "
MDD =~ NA*ClinAppDec + ClinAppInc + ClinSleDec + ClinSleInc + ClinMotoInc + ClinMotoDec + ClinSui + CommDep + CommAnh + CommAppDec + CommAppInc + CommSleDec + CommSleInc + CommFatig + CommGuilt + CommConc + CommSui + UkbDep + UkbAnh
GATE =~ NA*CommDep + CommAnh + UkbDep + UkbAnh

MDD ~~ 1*MDD
GATE ~~ 1*GATE
MDD ~~ 0*GATE
"

gate.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=gate.model)

gate.fit$modelfit
gate.fit$results[c(1,2,3,6,7)]

```

Gating symptoms, case and control symptoms, and case-only symptoms

```{r measure, cache=TRUE}

measure.model <- "
CLIN =~ NA*ClinAppDec + ClinAppInc + ClinSleDec + ClinSleInc + ClinMotoInc + ClinMotoDec + ClinSui
GATE =~ NA*CommDep + CommAnh + UkbDep + UkbAnh
COMM =~ NA*CommAppDec + CommAppInc + CommSleDec + CommSleInc + CommFatig + CommGuilt + CommConc + CommSui 

CLIN ~~ 1*CLIN
GATE ~~ 1*GATE
COMM ~~ 1*COMM
cl_co < 1
CLIN ~~ cl_co*COMM
"

measure.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=measure.model)

measure.fit$modelfit
measure.fit$results[c(1,2,3,6,7,9)]

```

Symptoms with positive genetic variance between cases vs others

```{r divergence, cache=TRUE}

divergence.model <- "
CASE =~ NA*ClinAppDec + ClinAppInc + ClinSleDec + ClinSleInc + ClinMotoInc + ClinMotoDec + ClinSui + CommAppDec + CommAppInc + CommSleDec + CommSleInc + CommSui
CASECON =~ NA*CommDep + CommAnh + UkbDep + UkbAnh + CommFatig + CommGuilt + CommConc 

CASE ~~ 1*CASE
CASECON ~~ 1*CASECON
"

divergence.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=divergence.model)

divergence.fit$modelfit
divergence.fit$results[c(1,2,3,6,7,9)]

```

## Baseline gating and directional symptoms factors

```{r base, cache=TRUE}

base.model <- "
MDD =~ NA*ClinAppDec + ClinAppInc + ClinSleDec + ClinSleInc + ClinMotoInc + ClinMotoDec + ClinSui + CommDep + CommAnh + CommAppDec + CommAppInc + CommSleDec + CommSleInc + CommFatig + CommGuilt + CommConc + CommSui + UkbDep + UkbAnh

GATE =~ NA*CommDep + CommAnh + UkbDep + UkbAnh
APP =~ NA*ClinAppDec + ClinAppInc + CommAppDec + CommAppInc
SLE =~ NA*ClinSleDec + ClinSleInc + CommSleDec + CommSleInc

MDD ~~ 1*MDD
GATE ~~ 1*GATE
APP ~~ 1*APP
SLE ~~ 1*SLE
MDD ~~ 0*GATE + 0*APP + 0*SLE
GATE ~~ 0*APP + 0*SLE
APP ~~ 0*SLE

c4a > 0
CommSleDec ~~ c4a*CommSleDec
u1 > 0
UkbDep ~~ u1*UkbDep
"

base.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=base.model)

base.fit$modelfit
base.fit$results[c(1,2,3,6,7)]

```


## Two-factor models

[Elhai Psychiat Res 2012](https://www.sciencedirect.com/science/article/pii/S0165178112002685) compared 3 two-factor models

### Psychological-Somatic (Elhai Model 2a)

[Krause Rehab Psychol 2008](https://psycnet.apa.org/record/2008-17022-011), [Krause Arch Psys Med Rehab 2010](https://www.sciencedirect.com/science/article/pii/S0003999310002443):

> the 2-factor solution with 3 somatic items (sleep disturbance, poor energy, appetite change) was a better solution than either a unidimensional model or 2-factor model that included psychomotor slowing as a fourth somatic item

```{r psych_soma, cache=TRUE}

psych_soma.model <- "
PSYCH =~ NA*ClinMotoInc + ClinMotoDec + ClinSui + CommDep + CommAnh + CommGuilt + CommConc + CommSui + UkbDep + UkbAnh
SOMA =~ NA*ClinAppDec + ClinAppInc + ClinSleDec + ClinSleInc + CommAppDec + CommAppInc + CommSleDec + CommSleInc + CommFatig

GATE =~ NA*CommDep + CommAnh + UkbDep + UkbAnh
APP =~ NA*ClinAppDec + ClinAppInc + CommAppDec + CommAppInc
SLE =~ NA*ClinSleDec + ClinSleInc + CommSleDec + CommSleInc

PSYCH ~~ 1*PSYCH
SOMA ~~ 1*SOMA
GATE ~~ 1*GATE
APP ~~ 1*APP
SLE ~~ 1*SLE
PSYCH ~~ 0*GATE + 0*APP + 0*SLE
SOMA ~~ 0*GATE + 0*APP + 0*SLE
GATE ~~ 0*APP + 0*SLE
APP ~~ 0*SLE
"

psych_soma.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=psych_soma.model)

psych_soma.fit$modelfit
psych_soma.fit$results[c(1,2,3,6,7)]

```


### Psychological-Neurovegetative (Elhai Model 2b)

```{r psych_veg, cache=TRUE}

psych_veg.model <- "
PSYCH =~ NA*ClinSui + CommDep + CommAnh + CommGuilt + CommConc + CommSui + UkbDep + UkbAnh
VEG =~ NA*ClinAppDec + ClinAppInc + ClinSleDec + ClinSleInc + ClinMotoInc + ClinMotoDec +  + CommAppDec + CommAppInc + CommSleDec + CommSleInc + CommFatig

GATE =~ NA*CommDep + CommAnh + UkbDep + UkbAnh
APP =~ NA*ClinAppDec + ClinAppInc + CommAppDec + CommAppInc
SLE =~ NA*ClinSleDec + ClinSleInc + CommSleDec + CommSleInc

PSYCH ~~ 1*PSYCH
VEG ~~ 1*VEG
GATE ~~ 1*GATE
APP ~~ 1*APP
SLE ~~ 1*SLE
PSYCH ~~ 0*GATE + 0*APP + 0*SLE
VEG ~~ 0*GATE + 0*APP + 0*SLE
GATE ~~ 0*APP + 0*SLE
APP ~~ 0*SLE
"
psych_veg.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=psych_veg.model)

psych_veg.fit$modelfit
psych_veg.fit$results[c(1,2,3,6,7)]

```


### Affective-Neurovegetative (Elhai Model 2c)

```{r affect_neuroveg, cache=TRUE}

affect_neuroveg.model <- "
PSYCH =~ NA*ClinSui + CommDep + CommAnh + CommGuilt + CommSui + UkbDep + UkbAnh
NEUROVEG =~ NA*ClinAppDec + ClinAppInc + ClinSleDec + ClinSleInc + ClinMotoInc + ClinMotoDec +  + CommAppDec + CommAppInc + CommSleDec + CommSleInc + CommFatig + CommConc

GATE =~ NA*CommDep + CommAnh + UkbDep + UkbAnh
APP =~ NA*ClinAppDec + ClinAppInc + CommAppDec + CommAppInc
SLE =~ NA*ClinSleDec + ClinSleInc + CommSleDec + CommSleInc

PSYCH ~~ 1*PSYCH
NEUROVEG ~~ 1*NEUROVEG
GATE ~~ 1*GATE
APP ~~ 1*APP
SLE ~~ 1*SLE
PSYCH ~~ 0*GATE + 0*APP + 0*SLE
NEUROVEG ~~ 0*GATE + 0*APP + 0*SLE
GATE ~~ 0*APP + 0*SLE
APP ~~ 0*SLE
"
affect_neuroveg.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=affect_neuroveg.model)

affect_neuroveg.fit$modelfit
affect_neuroveg.fit$results[c(1,2,3,6,7)]

```

## Three factor models

### Cognitive-Mood-Neuroveg (Kendler Neale) model

```{r cog_mood_neuroveg, cache=TRUE}

cog_mood_neuroveg.model <- "
COG =~ NA*ClinSui + CommGuilt + CommConc + CommSui
MOOD =~ NA*CommDep + CommAnh + CommGuilt + UkbDep + UkbAnh
VEG =~ NA*ClinAppDec + ClinAppInc + ClinSleDec + ClinSleInc + ClinMotoInc + ClinMotoDec +  + CommAppDec + CommAppInc + CommSleDec + CommSleInc + CommFatig

APP =~ NA*ClinAppDec + ClinAppInc + CommAppDec + CommAppInc
SLE =~ NA*ClinSleDec + ClinSleInc + CommSleDec + CommSleInc

COG ~~ 1*COG
MOOD ~~ 1*MOOD
VEG ~~ 1*VEG
APP ~~ 1*APP
SLE ~~ 1*SLE
COG ~~ 0*APP + 0*SLE
MOOD ~~ 0*APP + 0*SLE
VEG ~~ 0*APP + 0*SLE
APP ~~ 0*SLE
"
cog_mood_neuroveg.fit <- usermodel(symptoms_covstruct, estimation='DWLS', model=cog_mood_neuroveg.model)

cog_mood_neuroveg.fit$modelfit
cog_mood_neuroveg.fit$results[c(1,2,3,6,7)]

```

### Model comparisons

```{r model_list}

model_list=
list("1a"=list(name="Common", model=commonfactor.fit),
     "1b"=list(name="Common (App)", model=commonfactor_app.fit),
     "1c"=list(name="Common (Sle)", model=commonfactor_sle.fit),
     "1d"=list(name="Common (gating)", model=gate.fit),
     "1e"=list(name="Ascertainment", model=clin_comm.fit),
     "1f"=list(name="Divergence", model=divergence.fit),
     "1g"=list(name="Baseline", model=base.fit),
     "2a"=list(name="Psych-Somatic", model=psych_soma.fit),
     "2b"=list(name="Psych-Neuroveg", model=psych_veg.fit),
     "2c"=list(name="Affect-Neuroveg", model=affect_neuroveg.fit),
     "3"=list(name="Cog-Mood-Neuroveg", model=cog_mood_neuroveg.fit)
     )

model_fits <- 
data.frame(Model=names(model_list),
           Name=sapply(model_list, function(m) m$name)) %>%
bind_cols(
bind_rows(
lapply(model_list, function(m) m$model$modelfit)
))
rownames(model_fits) <- NULL

knitr::kable(
model_fits %>%
mutate(dAIC=AIC-min(AIC)) %>%
mutate_if(is.numeric, ~signif(., 3))
)


```
      
# Exploratory factor analysis

Get the genetic covariance matrix for symptoms with a positive heritability

```{r mdd_symptoms_cov}

symptoms_cov <- symptoms_covstruct$S
k <- nrow(symptoms_cov)
symptoms_se <- matrix(0, k, k)
symptoms_se[lower.tri(symptoms_se, diag=TRUE)] <- sqrt(diag(symptoms_covstruct$V))

symptoms_se[upper.tri(symptoms_se)] <- t(symptoms_se)[upper.tri(symptoms_se)]

symptoms_cov_keep <- which(diag(symptoms_cov > 0))

symptoms_cov_pos <- symptoms_cov[symptoms_cov_keep,symptoms_cov_keep]

```

Smooth the genetic covariance matrix so that it is positive definite
```{r mdd_symptom_gsem_efa_pd}

# smooth the covariance matrix
symptoms_cov_pd <- as.matrix(Matrix::nearPD(symptoms_covstruct$S, corr=FALSE)$mat)

corrplot(cov2cor(symptoms_cov_pd))

```


Check eigen values of the correlation matrix
```{r mdd_symptom_gsem_efa_eigen}

symptoms_eigen <- eigen(cov2cor(symptoms_cov_pd)) 

plot(symptoms_eigen$values, ylab='Eigenvalue')
lines(symptoms_eigen$values)
abline(1, 0, col='red')

symptoms_efa <- factanal(covmat=symptoms_cov_pd, factors=3, rotation='varimax')
print(symptoms_efa, cut=0.4)

```


